<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShiurPod - Admin Panel</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0f1a; color: #e2e8f0; min-height: 100vh; }
  .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
  .login-card { background: #151c2c; border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; border: 1px solid #1e293b; }
  .login-card h1 { font-size: 24px; margin-bottom: 8px; color: #f8fafc; }
  .login-card p { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 6px; font-weight: 500; }
  input, select, textarea { width: 100%; padding: 10px 14px; background: #0f172a; border: 1px solid #1e293b; border-radius: 8px; color: #e2e8f0; font-size: 14px; outline: none; transition: border 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: #3b82f6; }
  textarea { resize: vertical; min-height: 80px; }
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
  .btn-primary { background: #3b82f6; color: #fff; }
  .btn-primary:hover { background: #2563eb; }
  .btn-danger { background: #ef4444; color: #fff; }
  .btn-danger:hover { background: #dc2626; }
  .btn-secondary { background: #1e293b; color: #e2e8f0; }
  .btn-secondary:hover { background: #334155; }
  .btn-success { background: #059669; color: #fff; }
  .btn-success:hover { background: #047857; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }
  .btn-full { width: 100%; justify-content: center; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .admin-panel { display: none; }
  .header { background: #151c2c; border-bottom: 1px solid #1e293b; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
  .header h1 { font-size: 20px; color: #f8fafc; }
  .main { padding: 24px; max-width: 1400px; margin: 0 auto; }

  .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #151c2c; border-radius: 10px; padding: 4px; }
  .tab { flex: 1; padding: 10px 16px; border: none; background: none; color: #94a3b8; font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 8px; transition: all 0.15s; }
  .tab.active { background: #3b82f6; color: #fff; }
  .tab:hover:not(.active) { background: #1e293b; }

  .card { background: #151c2c; border-radius: 12px; border: 1px solid #1e293b; padding: 20px; margin-bottom: 16px; }
  .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
  .card-header h2 { font-size: 18px; color: #f8fafc; }

  .feed-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: #0f172a; border-radius: 10px; margin-bottom: 8px; }
  .feed-img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #1e293b; flex-shrink: 0; }
  .feed-info { flex: 1; min-width: 0; }
  .feed-title { font-weight: 600; font-size: 14px; color: #f8fafc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .feed-meta { font-size: 12px; color: #64748b; margin-top: 2px; }
  .feed-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .feed-stats-inline { display: flex; gap: 12px; margin-top: 4px; }
  .feed-stat { font-size: 11px; color: #94a3b8; }
  .feed-stat strong { color: #e2e8f0; }

  .category-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #0f172a; border-radius: 6px; font-size: 13px; color: #94a3b8; margin: 0 6px 6px 0; }
  .category-tag .remove { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; line-height: 1; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
  .modal { background: #151c2c; border-radius: 16px; border: 1px solid #1e293b; padding: 24px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
  .modal h2 { font-size: 18px; color: #f8fafc; margin-bottom: 20px; }

  .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .status-active { background: #065f46; color: #6ee7b7; }
  .status-inactive { background: #7f1d1d; color: #fca5a5; }

  .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; }
  .alert-success { background: #064e3b; color: #6ee7b7; border: 1px solid #065f46; }
  .alert-error { background: #7f1d1d; color: #fca5a5; border: 1px solid #991b1b; }
  .hidden { display: none !important; }

  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: #151c2c; border: 1px solid #1e293b; border-radius: 12px; padding: 16px; }
  .stat-value { font-size: 28px; font-weight: 700; color: #f8fafc; }
  .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
  .stat-sub { font-size: 11px; color: #3b82f6; margin-top: 2px; }

  .search-container { position: relative; }
  .search-container input { padding-right: 40px; }
  .search-spinner { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display: none; }
  .search-spinner.active { display: block; }
  .spinner { width: 18px; height: 18px; border: 2px solid #1e293b; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .search-results { margin-top: 12px; max-height: 400px; overflow-y: auto; }
  .search-result { display: flex; align-items: center; gap: 12px; padding: 12px; background: #0f172a; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: background 0.15s; border: 1px solid transparent; }
  .search-result:hover { background: #1e293b; border-color: #334155; }
  .search-result.selected { border-color: #3b82f6; background: #172554; }
  .search-result img { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
  .search-result-info { flex: 1; min-width: 0; }
  .search-result-title { font-weight: 600; font-size: 14px; color: #f8fafc; }
  .search-result-meta { font-size: 12px; color: #64748b; margin-top: 2px; }
  .search-result-genre { display: inline-block; font-size: 11px; color: #94a3b8; background: #1e293b; padding: 2px 8px; border-radius: 4px; margin-top: 4px; }

  .preview-card { background: #0f172a; border-radius: 10px; padding: 16px; margin-top: 12px; display: flex; gap: 14px; align-items: flex-start; }
  .preview-card img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }
  .preview-info { flex: 1; }
  .preview-info h3 { font-size: 16px; color: #f8fafc; margin-bottom: 4px; }
  .preview-info p { font-size: 13px; color: #94a3b8; margin-bottom: 4px; }
  .preview-info .ep-count { font-size: 12px; color: #3b82f6; }

  .tab-mode-toggle { display: flex; gap: 4px; background: #0f172a; border-radius: 8px; padding: 3px; margin-bottom: 16px; }
  .tab-mode-btn { padding: 8px 16px; border: none; background: none; color: #94a3b8; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 6px; transition: all 0.15s; }
  .tab-mode-btn.active { background: #1e293b; color: #f8fafc; }

  .chart-container { padding: 16px 0; }
  .chart-bar-container { display: flex; align-items: flex-end; gap: 3px; height: 120px; padding: 0 4px; }
  .chart-bar { flex: 1; background: #3b82f6; border-radius: 3px 3px 0 0; min-width: 4px; transition: height 0.3s; position: relative; }
  .chart-bar:hover { background: #60a5fa; }
  .chart-bar:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: #f8fafc; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; margin-bottom: 4px; }
  .chart-label { font-size: 11px; color: #64748b; text-align: center; margin-top: 4px; }

  .top-episodes { list-style: none; }
  .top-episode { display: flex; align-items: center; gap: 10px; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 6px; }
  .top-episode-rank { font-size: 16px; font-weight: 700; color: #64748b; width: 24px; text-align: center; flex-shrink: 0; }
  .top-episode-title { font-size: 13px; color: #f8fafc; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .top-episode-count { font-size: 12px; color: #3b82f6; font-weight: 600; flex-shrink: 0; }

  .feed-table { width: 100%; border-collapse: collapse; }
  .feed-table th { text-align: left; font-size: 12px; color: #64748b; font-weight: 500; padding: 8px 12px; border-bottom: 1px solid #1e293b; }
  .feed-table td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #0f172a; }
  .feed-table tr:hover td { background: #0f172a; }

  .toggle-btn { width: 40px; height: 22px; border-radius: 11px; border: none; cursor: pointer; position: relative; transition: background 0.2s; }
  .toggle-btn.on { background: #059669; }
  .toggle-btn.off { background: #334155; }
  .toggle-btn::after { content: ''; width: 16px; height: 16px; border-radius: 50%; background: #fff; position: absolute; top: 3px; transition: left 0.2s; }
  .toggle-btn.on::after { left: 21px; }
  .toggle-btn.off::after { left: 3px; }

  .featured-star { background: none; border: none; cursor: pointer; font-size: 20px; color: #94a3b8; transition: color 0.2s; padding: 4px 8px; }
  .featured-star.featured { color: #fbbf24; }
  .featured-star:hover { color: #fbbf24; }

  @media (max-width: 768px) {
    .feed-item { flex-wrap: wrap; }
    .feed-actions { width: 100%; justify-content: flex-end; margin-top: 8px; }
    .stats { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <h1>Admin Panel</h1>
    <p>ShiurPod App Management</p>
    <div id="loginAlert" class="alert alert-error hidden"></div>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="loginUser" value="admin">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPass" value="admin123">
    </div>
    <button class="btn btn-primary btn-full" onclick="login()">Sign In</button>
  </div>
</div>

<div id="adminPanel" class="admin-panel">
  <div class="header">
    <h1>ShiurPod Admin</h1>
    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <div id="alertArea"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('analytics', this)">Analytics</button>
      <button class="tab" onclick="switchTab('feeds', this)">Feeds</button>
      <button class="tab" onclick="switchTab('categories', this)">Categories</button>
      <button class="tab" onclick="switchTab('errors', this)">Error Reports</button>
      <button class="tab" onclick="switchTab('feedback', this)">Feedback</button>
      <button class="tab" onclick="switchTab('messages', this)">Messages</button>
      <button class="tab" onclick="switchTab('apk', this)">APK</button>
      <button class="tab" onclick="switchTab('settings', this)">Settings</button>
    </div>

    <div id="analyticsTab">
      <div class="stats" id="statsArea"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card" style="grid-column:1/3;">
          <div class="card-header">
            <h2>Listens (Last 30 Days)</h2>
          </div>
          <div id="listenChart" class="chart-container"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Top Episodes</h2>
          </div>
          <div id="topEpisodes"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Feed Performance</h2>
          </div>
          <div id="feedPerformance" style="max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <div id="feedsTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Approved RSS Feeds</h2>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="refreshAllFeeds()">Refresh All</button>
            <button class="btn btn-success btn-sm" onclick="showBulkImportModal()">Bulk Import</button>
            <button class="btn btn-primary btn-sm" onclick="showAddFeedModal()">Add Feed</button>
          </div>
        </div>
        <div id="feedList"></div>
      </div>
    </div>

    <div id="categoriesTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Categories</h2>
          <button class="btn btn-primary btn-sm" onclick="showAddCategoryModal()">Add Category</button>
        </div>
        <div id="categoryList"></div>
      </div>
    </div>

    <div id="errorsTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Error Reports</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select id="errorLevelFilter" onchange="loadErrorReports()" style="width:auto;padding:6px 10px;font-size:12px;">
              <option value="">All Levels</option>
              <option value="error">Errors Only</option>
              <option value="warn">Warnings Only</option>
              <option value="info">Info Only</option>
            </select>
            <select id="errorResolvedFilter" onchange="loadErrorReports()" style="width:auto;padding:6px 10px;font-size:12px;">
              <option value="false">Unresolved</option>
              <option value="true">Resolved</option>
              <option value="">All</option>
            </select>
            <button class="btn btn-danger btn-sm" onclick="deleteResolvedErrors()">Delete Resolved</button>
          </div>
        </div>
        <div id="errorReportsSummary" style="margin-bottom:12px;font-size:13px;color:#94a3b8;"></div>
        <div id="errorReportsList"></div>
        <div id="errorReportsPagination" style="display:flex;gap:8px;justify-content:center;margin-top:16px;"></div>
      </div>
    </div>

    <div id="messagesTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Contact Messages</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="messageStatusFilter" onchange="loadMessages()" style="width:auto;padding:6px 10px;font-size:12px;">
              <option value="">All</option>
              <option value="new">New</option>
              <option value="read">Read</option>
              <option value="replied">Replied</option>
            </select>
          </div>
        </div>
        <div id="messagesList"></div>
        <div id="messagesPagination" style="display:flex;gap:8px;justify-content:center;margin-top:16px;"></div>
      </div>
    </div>

    <div id="apkTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>APK Management</h2>
        </div>
        <div style="margin-bottom:16px;padding:16px;background:#0f172a;border-radius:10px;">
          <h3 style="font-size:14px;color:#f8fafc;margin-bottom:12px;">Upload New APK</h3>
          <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;">
            <div class="form-group" style="flex:1;min-width:200px;margin-bottom:0;">
              <label>APK File</label>
              <input type="file" id="apkFile" accept=".apk" style="padding:8px;">
            </div>
            <div class="form-group" style="width:150px;margin-bottom:0;">
              <label>Version (optional)</label>
              <input type="text" id="apkVersion" placeholder="e.g., 1.0.3">
            </div>
            <button class="btn btn-primary" onclick="uploadApk()" id="uploadApkBtn">Upload</button>
          </div>
          <div id="apkUploadProgress" style="margin-top:8px;display:none;">
            <div style="background:#1e293b;border-radius:4px;height:6px;overflow:hidden;">
              <div id="apkProgressBar" style="background:#3b82f6;height:100%;width:0%;transition:width 0.3s;"></div>
            </div>
            <span id="apkProgressText" style="font-size:11px;color:#94a3b8;margin-top:4px;display:block;"></span>
          </div>
        </div>
        <div id="apkList"></div>
      </div>
    </div>

    <div id="settingsTab" class="hidden">
      <div class="card" style="max-width:500px;">
        <div class="card-header">
          <h2>Change Password</h2>
        </div>
        <div id="settingsAlert"></div>
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" id="currentPassword">
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword">
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPassword">
        </div>
        <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
      </div>
    </div>

    <div id="feedbackTab" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>User Feedback</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select id="feedbackTypeFilter" onchange="loadFeedback()" style="width:auto;padding:6px 10px;font-size:12px;">
              <option value="">All Types</option>
              <option value="shiur_request">Shiur Requests</option>
              <option value="technical_issue">Technical Issues</option>
            </select>
            <select id="feedbackStatusFilter" onchange="loadFeedback()" style="width:auto;padding:6px 10px;font-size:12px;">
              <option value="new">New</option>
              <option value="reviewed">Reviewed</option>
              <option value="resolved">Resolved</option>
              <option value="">All</option>
            </select>
          </div>
        </div>
        <div id="feedbackList"></div>
        <div id="feedbackPagination" style="display:flex;gap:8px;justify-content:center;margin-top:16px;"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalOverlay" class="modal-overlay hidden" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div id="modalContent"></div>
  </div>
</div>

<script>
let token = localStorage.getItem('admin_token') || '';
let categories = [];
let analyticsData = null;
let searchTimeout = null;
let selectedSearchResult = null;

const api = async (url, opts = {}) => {
  const headers = { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Basic ${token}` } : {}), ...opts.headers };
  const res = await fetch(url, { ...opts, headers });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || 'Request failed');
  }
  return res.json();
};

async function login() {
  const user = document.getElementById('loginUser').value;
  const pass = document.getElementById('loginPass').value;
  try {
    const data = await api('/api/admin/login', { method: 'POST', body: JSON.stringify({ username: user, password: pass }) });
    token = data.token;
    localStorage.setItem('admin_token', token);
    showAdmin();
  } catch (e) {
    const el = document.getElementById('loginAlert');
    el.textContent = e.message;
    el.classList.remove('hidden');
  }
}

function logout() {
  token = '';
  localStorage.removeItem('admin_token');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('adminPanel').style.display = 'none';
}

async function showAdmin() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'block';
  await Promise.all([loadAnalytics(), loadFeeds(), loadCategories()]);
}

function showAlert(msg, type = 'success') {
  const area = document.getElementById('alertArea');
  area.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => area.innerHTML = '', 4000);
}

async function loadAnalytics() {
  try {
    analyticsData = await api('/api/admin/analytics');
    const enhanced = await api('/api/admin/analytics/enhanced').catch(() => null);
    if (enhanced) analyticsData.enhanced = enhanced;
    renderStats();
    renderListenChart();
    renderTopEpisodes();
    renderFeedPerformance();
    if (enhanced) renderEnhancedStats();
  } catch(e) {
    console.error('Analytics error:', e);
  }
}

function renderStats() {
  if (!analyticsData) return;
  const d = analyticsData;
  const enhanced = d.enhanced || {};
  
  const avgListenTimeMs = enhanced.totalListeningTimeMs && d.totalListens ? Math.round(enhanced.totalListeningTimeMs / d.totalListens) : 0;
  const avgListenTimeMin = Math.round(avgListenTimeMs / 60000);
  const totalFavorites = d.feedStats ? d.feedStats.reduce((sum, f) => sum, 0) : 0;
  
  document.getElementById('statsArea').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${d.totalListens.toLocaleString()}</div>
      <div class="stat-label">Total Listens</div>
      <div class="stat-sub">${d.recentListens.toLocaleString()} this week</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${d.uniqueDevices.toLocaleString()}</div>
      <div class="stat-label">Active Devices</div>
      <div class="stat-sub">${d.totalSubscriptions.toLocaleString()} subscriptions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${d.activeFeeds}</div>
      <div class="stat-label">Active Feeds</div>
      <div class="stat-sub">${d.totalFeeds} total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${d.totalEpisodes.toLocaleString()}</div>
      <div class="stat-label">Total Episodes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${d.totalCategories}</div>
      <div class="stat-label">Categories</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${enhanced.completedEpisodes ? enhanced.completedEpisodes.toLocaleString() : '0'}</div>
      <div class="stat-label">Completed Episodes</div>
      <div class="stat-sub">${enhanced.totalListeningTimeMs ? (enhanced.totalListeningTimeMs / 3600000).toFixed(0) + ' hours total' : 'No data'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${avgListenTimeMin}</div>
      <div class="stat-label">Avg Listen Time</div>
      <div class="stat-sub">minutes per session</div>
    </div>
  `;
}

function renderListenChart() {
  if (!analyticsData) return;
  const container = document.getElementById('listenChart');
  const data = analyticsData.dailyListens;

  if (data.length === 0) {
    container.innerHTML = '<p style="color:#64748b;text-align:center;padding:40px;">No listen data yet. Listens will appear here once users start listening.</p>';
    return;
  }

  const maxCount = Math.max(...data.map(d => d.count), 1);
  const bars = data.map(d => {
    const height = Math.max((d.count / maxCount) * 100, 2);
    const date = new Date(d.day);
    const label = `${date.getMonth()+1}/${date.getDate()}`;
    return `<div class="chart-bar" style="height:${height}%" data-tooltip="${d.count} listens on ${label}"></div>`;
  }).join('');

  container.innerHTML = `
    <div class="chart-bar-container">${bars}</div>
    <div style="display:flex;justify-content:space-between;padding:0 4px;">
      <span class="chart-label">${formatDate(data[0].day)}</span>
      <span class="chart-label">${formatDate(data[data.length-1].day)}</span>
    </div>
  `;
}

function renderTopEpisodes() {
  if (!analyticsData) return;
  const container = document.getElementById('topEpisodes');
  const eps = analyticsData.topEpisodes;

  if (eps.length === 0) {
    container.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No data yet.</p>';
    return;
  }

  container.innerHTML = '<div class="top-episodes">' + eps.map((ep, i) => `
    <div class="top-episode">
      <div class="top-episode-rank">${i + 1}</div>
      <div class="top-episode-title" title="${esc(ep.title)}">${esc(ep.title)}</div>
      <div class="top-episode-count">${ep.listenCount} plays</div>
    </div>
  `).join('') + '</div>';
}

function renderFeedPerformance() {
  if (!analyticsData) return;
  const container = document.getElementById('feedPerformance');
  const stats = analyticsData.feedStats;

  if (stats.length === 0) {
    container.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No feeds added yet.</p>';
    return;
  }

  container.innerHTML = '<table class="feed-table"><thead><tr><th>Feed</th><th>Episodes</th><th>Listens</th><th>Subscribers</th></tr></thead><tbody>' +
    stats.map(f => `
      <tr>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(f.title)}">${esc(f.title)}</td>
        <td>${f.episodeCount}</td>
        <td>${f.listenCount}</td>
        <td>${f.subscriberCount}</td>
      </tr>
    `).join('') + '</tbody></table>';
}

function renderEnhancedStats() {
  if (!analyticsData || !analyticsData.enhanced) return;
  const enhanced = analyticsData.enhanced;
  const topListeners = enhanced.topListeners || [];
  
  if (topListeners.length === 0) {
    document.getElementById('enhancedStatsArea')?.remove();
    return;
  }

  let existingArea = document.getElementById('enhancedStatsArea');
  if (!existingArea) {
    const chartContainer = document.querySelector('[style*="grid-template-columns"]');
    if (!chartContainer) return;
    
    existingArea = document.createElement('div');
    existingArea.id = 'enhancedStatsArea';
    existingArea.className = 'card';
    existingArea.style.gridColumn = '1/3';
    chartContainer.appendChild(existingArea);
  }

  existingArea.innerHTML = `
    <div class="card-header">
      <h2>Top Listeners</h2>
    </div>
    <div style="max-height:300px;overflow-y:auto;">
      <table class="feed-table" style="margin-bottom:0;">
        <thead>
          <tr>
            <th>Device ID</th>
            <th style="text-align:right;">Listens</th>
          </tr>
        </thead>
        <tbody>
          ${topListeners.map((listener, i) => `
            <tr>
              <td style="font-family:monospace;font-size:12px;color:#94a3b8;">${esc(listener.deviceId.substring(0, 12))}...</td>
              <td style="text-align:right;font-weight:600;color:#3b82f6;">${listener.listenCount}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

async function loadFeeds() {
  try {
    const feeds = await api('/api/admin/feeds');
    const list = document.getElementById('feedList');
    if (feeds.length === 0) {
      list.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No feeds added yet. Click "Add Feed" to get started.</p>';
      return;
    }
    list.innerHTML = feeds.map(f => `
      <div class="feed-item">
        ${f.imageUrl ? `<img src="${f.imageUrl}" class="feed-img" onerror="this.style.display='none'">` : '<div class="feed-img"></div>'}
        <div class="feed-info">
          <div class="feed-title">${esc(f.title)}</div>
          <div class="feed-meta">${esc(f.author || 'Unknown')} &bull; ${categories.find(c => c.id === f.categoryId)?.name || 'Uncategorized'}</div>
          <div class="feed-meta" style="font-size:11px;margin-top:2px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(f.rssUrl)}</div>
        </div>
        <button class="toggle-btn ${f.isActive ? 'on' : 'off'}" onclick="toggleFeedActive('${f.id}', ${!f.isActive})" title="${f.isActive ? 'Active' : 'Inactive'}"></button>
        <button class="featured-star ${f.isFeatured ? 'featured' : ''}" onclick="toggleFeedFeatured('${f.id}', ${!f.isFeatured})" title="${f.isFeatured ? 'Featured' : 'Not Featured'}">★</button>
        <div class="feed-actions">
          <button class="btn btn-secondary btn-sm" onclick="editFeed('${f.id}')">Edit</button>
          <button class="btn btn-secondary btn-sm" onclick="refreshFeed('${f.id}')">Refresh</button>
          <button class="btn btn-danger btn-sm" onclick="deleteFeed('${f.id}')">Remove</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    if (e.message.includes('Unauthorized')) logout();
  }
}

async function loadCategories() {
  try {
    categories = await api('/api/categories');
    const list = document.getElementById('categoryList');
    if (categories.length === 0) {
      list.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No categories yet. Add some to organize your feeds.</p>';
      return;
    }
    list.innerHTML = '<div style="display:flex;flex-wrap:wrap;">' + categories.map(c => `
      <div class="category-tag">${esc(c.name)} <button class="remove" onclick="deleteCategory('${c.id}')">&times;</button></div>
    `).join('') + '</div>';
  } catch(e) {}
}

function showAddFeedModal() {
  selectedSearchResult = null;
  const catOptions = categories.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
  document.getElementById('modalContent').innerHTML = `
    <h2>Add Shiur Feed</h2>
    <div class="tab-mode-toggle">
      <button class="tab-mode-btn active" onclick="switchAddMode('search', this)">Search</button>
      <button class="tab-mode-btn" onclick="switchAddMode('url', this)">Paste URL</button>
    </div>

    <div id="addModeSearch">
      <div class="form-group">
        <label>Search by name</label>
        <div class="search-container">
          <input type="text" id="podcastSearch" placeholder="Search for a podcast or shiur..." oninput="handleSearch(this.value)">
          <div id="searchSpinner" class="search-spinner"><div class="spinner"></div></div>
        </div>
      </div>
      <div id="searchResults" class="search-results"></div>
      <div id="feedPreview"></div>
    </div>

    <div id="addModeUrl" class="hidden">
      <div class="form-group">
        <label>RSS Feed URL</label>
        <input type="url" id="feedUrl" placeholder="https://example.com/feed.xml">
      </div>
      <div id="urlPreview"></div>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="previewUrl()">Preview Feed</button>
    </div>

    <div class="form-group" style="margin-top:16px;">
      <label>Category</label>
      <select id="feedCategory"><option value="">Uncategorized</option>${catOptions}</select>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="addFeedBtn" onclick="addFeed()">Add Feed</button>
    </div>
  `;
  document.getElementById('modalOverlay').classList.remove('hidden');
  setTimeout(() => document.getElementById('podcastSearch')?.focus(), 100);
}

function switchAddMode(mode, btn) {
  document.querySelectorAll('.tab-mode-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('addModeSearch').classList.toggle('hidden', mode !== 'search');
  document.getElementById('addModeUrl').classList.toggle('hidden', mode !== 'url');
  selectedSearchResult = null;
}

function handleSearch(term) {
  clearTimeout(searchTimeout);
  if (term.trim().length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  document.getElementById('searchSpinner').classList.add('active');
  searchTimeout = setTimeout(async () => {
    try {
      const data = await api(`/api/admin/search-podcasts?term=${encodeURIComponent(term)}`);
      renderSearchResults(data.results);
    } catch(e) {
      document.getElementById('searchResults').innerHTML = `<p style="color:#fca5a5;font-size:13px;">Search failed: ${esc(e.message)}</p>`;
    } finally {
      document.getElementById('searchSpinner').classList.remove('active');
    }
  }, 400);
}

function renderSearchResults(results) {
  const container = document.getElementById('searchResults');
  if (results.length === 0) {
    container.innerHTML = '<p style="color:#64748b;font-size:13px;padding:12px;">No results found. Try a different search term, or paste the RSS URL directly.</p>';
    return;
  }
  container.innerHTML = results.map((r, i) => `
    <div class="search-result" onclick="selectSearchResult(${i})" id="sr-${i}">
      ${r.artworkUrl ? `<img src="${r.artworkUrl}" onerror="this.style.display='none'">` : '<div style="width:56px;height:56px;background:#1e293b;border-radius:8px;flex-shrink:0;"></div>'}
      <div class="search-result-info">
        <div class="search-result-title">${esc(r.name)}</div>
        <div class="search-result-meta">${esc(r.artist || 'Unknown')}</div>
        <div style="display:flex;gap:6px;align-items:center;margin-top:4px;">
          ${r.genre ? `<span class="search-result-genre">${esc(r.genre)}</span>` : ''}
          ${r.episodeCount ? `<span style="font-size:11px;color:#64748b;">${r.episodeCount} episodes</span>` : ''}
        </div>
      </div>
    </div>
  `).join('');
  window._searchResults = results;
}

async function selectSearchResult(index) {
  const results = window._searchResults;
  if (!results || !results[index]) return;
  const r = results[index];

  document.querySelectorAll('.search-result').forEach(el => el.classList.remove('selected'));
  document.getElementById(`sr-${index}`).classList.add('selected');

  selectedSearchResult = r;

  const preview = document.getElementById('feedPreview');
  preview.innerHTML = `
    <div class="preview-card">
      ${r.artworkUrl ? `<img src="${r.artworkUrl}" onerror="this.style.display='none'">` : ''}
      <div class="preview-info">
        <h3>${esc(r.name)}</h3>
        <p>${esc(r.artist || 'Unknown author')}</p>
        <div class="ep-count">Feed URL: ${esc(r.feedUrl)}</div>
        <div style="margin-top:4px;font-size:11px;color:#64748b;">Click "Add Feed" to import this shiur</div>
      </div>
    </div>
  `;
}

async function previewUrl() {
  const rssUrl = document.getElementById('feedUrl').value.trim();
  if (!rssUrl) return;
  const preview = document.getElementById('urlPreview');
  preview.innerHTML = '<p style="color:#94a3b8;font-size:13px;padding:8px;">Loading preview...</p>';
  try {
    const data = await api('/api/admin/preview-feed', { method: 'POST', body: JSON.stringify({ rssUrl }) });
    preview.innerHTML = `
      <div class="preview-card">
        ${data.imageUrl ? `<img src="${data.imageUrl}" onerror="this.style.display='none'">` : ''}
        <div class="preview-info">
          <h3>${esc(data.title)}</h3>
          <p>${esc(data.author || 'Unknown author')}</p>
          ${data.description ? `<p style="font-size:12px;color:#64748b;margin-top:4px;max-height:60px;overflow:hidden;">${esc(data.description.slice(0, 200))}</p>` : ''}
          <div class="ep-count">${data.episodeCount} episodes found</div>
        </div>
      </div>
    `;
  } catch(e) {
    preview.innerHTML = `<p style="color:#fca5a5;font-size:13px;padding:8px;">${esc(e.message)}</p>`;
  }
}

function showAddCategoryModal() {
  document.getElementById('modalContent').innerHTML = `
    <h2>Add Category</h2>
    <div class="form-group"><label>Name</label><input type="text" id="catName" placeholder="e.g., Halacha"></div>
    <div class="form-group"><label>Slug</label><input type="text" id="catSlug" placeholder="e.g., halacha"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
    </div>
  `;
  document.getElementById('modalOverlay').classList.remove('hidden');
}

function closeModal(e) {
  if (e && e.target !== e.currentTarget) return;
  document.getElementById('modalOverlay').classList.add('hidden');
  selectedSearchResult = null;
}

async function addFeed() {
  const btn = document.getElementById('addFeedBtn');
  btn.disabled = true;
  btn.textContent = 'Adding...';

  let rssUrl;
  const isSearch = !document.getElementById('addModeSearch').classList.contains('hidden');

  if (isSearch && selectedSearchResult) {
    rssUrl = selectedSearchResult.feedUrl;
  } else {
    rssUrl = document.getElementById('feedUrl')?.value?.trim();
  }

  const categoryId = document.getElementById('feedCategory').value || null;

  if (!rssUrl) {
    showAlert('Please select a podcast from search results or enter an RSS URL.', 'error');
    btn.disabled = false;
    btn.textContent = 'Add Feed';
    return;
  }

  try {
    await api('/api/admin/feeds', { method: 'POST', body: JSON.stringify({ rssUrl, categoryId }) });
    closeModal();
    showAlert('Feed added and episodes fetched!');
    await Promise.all([loadFeeds(), loadAnalytics()]);
  } catch (e) {
    showAlert(e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Add Feed';
  }
}

async function addCategory() {
  const name = document.getElementById('catName').value.trim();
  const slug = document.getElementById('catSlug').value.trim() || name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  if (!name) return;
  try {
    await api('/api/admin/categories', { method: 'POST', body: JSON.stringify({ name, slug }) });
    closeModal();
    showAlert('Category added!');
    await Promise.all([loadCategories(), loadAnalytics()]);
  } catch (e) {
    showAlert(e.message, 'error');
  }
}

async function deleteFeed(id) {
  if (!confirm('Remove this feed and all its episodes?')) return;
  try {
    await api(`/api/admin/feeds/${id}`, { method: 'DELETE' });
    showAlert('Feed removed');
    await Promise.all([loadFeeds(), loadAnalytics()]);
  } catch (e) {
    showAlert(e.message, 'error');
  }
}

async function deleteCategory(id) {
  if (!confirm('Remove this category?')) return;
  try {
    await api(`/api/admin/categories/${id}`, { method: 'DELETE' });
    showAlert('Category removed');
    await Promise.all([loadCategories(), loadAnalytics()]);
  } catch (e) {
    showAlert(e.message, 'error');
  }
}

async function refreshFeed(id) {
  try {
    const data = await api(`/api/admin/feeds/${id}/refresh`, { method: 'POST' });
    showAlert(`Feed refreshed! ${data.newEpisodes} new episodes found.`);
  } catch (e) {
    showAlert(e.message, 'error');
  }
}

async function refreshAllFeeds() {
  try {
    showAlert('Refreshing all feeds...', 'success');
    const data = await api('/api/admin/feeds/refresh-all', { method: 'POST' });
    showAlert(`Refreshed ${data.refreshed} feeds. ${data.newEpisodes} new episodes found.`);
    await loadFeeds();
  } catch (e) {
    showAlert(e.message, 'error');
  }
}

let bulkSelectedFeeds = [];

function showBulkImportModal() {
  bulkSelectedFeeds = [];
  document.getElementById('modalContent').innerHTML = `
    <h2 style="margin-bottom:16px;color:#f8fafc;">Bulk Import Shiurim</h2>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="btn btn-primary btn-sm" onclick="showBulkSearchView()" id="bulkSearchBtn" style="opacity:1;">Search</button>
      <button class="btn btn-secondary btn-sm" onclick="showBulkUrlView()" id="bulkUrlBtn">Paste URLs</button>
    </div>
    <div id="bulkSearchView">
      <div class="form-group" style="margin-bottom:8px;">
        <div style="display:flex;gap:6px;">
          <input type="text" id="bulkSearchInput" placeholder="Search podcasts..." style="flex:1;" onkeydown="if(event.key==='Enter')bulkSearch()">
          <button class="btn btn-primary btn-sm" onclick="bulkSearch()">Search</button>
        </div>
      </div>
      <div id="bulkSearchResults" style="max-height:300px;overflow-y:auto;margin-bottom:8px;"></div>
      <div id="bulkSelectedSummary" style="margin-bottom:8px;"></div>
    </div>
    <div id="bulkUrlView" class="hidden">
      <div class="form-group">
        <label>RSS URLs (one per line)</label>
        <textarea id="bulkUrls" rows="8" placeholder="https://example.com/feed1.xml&#10;https://example.com/feed2.xml"></textarea>
      </div>
    </div>
    <div class="form-group">
      <label>Category (optional)</label>
      <select id="bulkCategory">
        <option value="">No Category</option>
        ${(categories || []).map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('')}
      </select>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModal(event)">Cancel</button>
      <button class="btn btn-primary" onclick="bulkImport()" id="bulkImportBtn">Import Selected (0)</button>
    </div>
  `;
  document.getElementById('modalOverlay').classList.remove('hidden');
  setTimeout(() => document.getElementById('bulkSearchInput')?.focus(), 100);
}

function showBulkSearchView() {
  document.getElementById('bulkSearchView').classList.remove('hidden');
  document.getElementById('bulkUrlView').classList.add('hidden');
  document.getElementById('bulkSearchBtn').classList.remove('btn-secondary');
  document.getElementById('bulkSearchBtn').classList.add('btn-primary');
  document.getElementById('bulkUrlBtn').classList.remove('btn-primary');
  document.getElementById('bulkUrlBtn').classList.add('btn-secondary');
}

function showBulkUrlView() {
  document.getElementById('bulkSearchView').classList.add('hidden');
  document.getElementById('bulkUrlView').classList.remove('hidden');
  document.getElementById('bulkUrlBtn').classList.remove('btn-secondary');
  document.getElementById('bulkUrlBtn').classList.add('btn-primary');
  document.getElementById('bulkSearchBtn').classList.remove('btn-primary');
  document.getElementById('bulkSearchBtn').classList.add('btn-secondary');
}

async function bulkSearch() {
  const term = document.getElementById('bulkSearchInput').value.trim();
  if (term.length < 2) return showAlert('Enter at least 2 characters', 'error');
  const results = document.getElementById('bulkSearchResults');
  results.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:20px;">Searching...</p>';
  try {
    const data = await api(`/api/admin/search-podcasts?term=${encodeURIComponent(term)}`);
    if (!data.results || data.results.length === 0) {
      results.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No results found</p>';
      return;
    }
    results.innerHTML = data.results.map(r => {
      const isSelected = bulkSelectedFeeds.some(f => f.feedUrl === r.feedUrl);
      return `<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:${isSelected ? '#1e3a5f' : '#0f172a'};margin-bottom:4px;cursor:pointer;" onclick="toggleBulkSelect('${esc(r.feedUrl)}','${esc(r.name)}','${esc(r.artworkUrl || '')}')">
        <input type="checkbox" ${isSelected ? 'checked' : ''} style="flex-shrink:0;width:18px;height:18px;accent-color:#3b82f6;" onclick="event.stopPropagation();toggleBulkSelect('${esc(r.feedUrl)}','${esc(r.name)}','${esc(r.artworkUrl || '')}')">
        ${r.artworkUrl ? `<img src="${esc(r.artworkUrl)}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;">` : '<div style="width:40px;height:40px;border-radius:6px;background:#334155;flex-shrink:0;"></div>'}
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:600;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.name)}</div>
          <div style="font-size:11px;color:#94a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(r.artist || '')} ${r.episodeCount ? '· ' + r.episodeCount + ' episodes' : ''}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    results.innerHTML = `<p style="color:#ef4444;text-align:center;padding:20px;">${e.message}</p>`;
  }
}

function toggleBulkSelect(feedUrl, name, artworkUrl) {
  const idx = bulkSelectedFeeds.findIndex(f => f.feedUrl === feedUrl);
  if (idx >= 0) {
    bulkSelectedFeeds.splice(idx, 1);
  } else {
    bulkSelectedFeeds.push({ feedUrl, name, artworkUrl });
  }
  updateBulkSummary();
  const results = document.getElementById('bulkSearchResults');
  if (results.children.length > 0) bulkSearch();
}

function updateBulkSummary() {
  const btn = document.getElementById('bulkImportBtn');
  if (btn) btn.textContent = `Import Selected (${bulkSelectedFeeds.length})`;
  const summary = document.getElementById('bulkSelectedSummary');
  if (!summary) return;
  if (bulkSelectedFeeds.length === 0) {
    summary.innerHTML = '';
    return;
  }
  summary.innerHTML = `
    <div style="font-size:12px;color:#3b82f6;margin-bottom:4px;">${bulkSelectedFeeds.length} selected:</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;">
      ${bulkSelectedFeeds.map(f => `<span style="background:#1e3a5f;color:#93c5fd;padding:2px 8px;border-radius:12px;font-size:11px;display:flex;align-items:center;gap:4px;">
        ${esc(f.name.length > 25 ? f.name.substring(0,25) + '...' : f.name)}
        <span style="cursor:pointer;font-weight:bold;" onclick="event.stopPropagation();toggleBulkSelect('${esc(f.feedUrl)}','${esc(f.name)}','${esc(f.artworkUrl || '')}')">×</span>
      </span>`).join('')}
    </div>`;
}

async function bulkImport() {
  const isUrlView = !document.getElementById('bulkUrlView').classList.contains('hidden');
  let urls = [];

  if (isUrlView) {
    const urlsText = (document.getElementById('bulkUrls')?.value || '').trim();
    if (!urlsText) return showAlert('Please enter at least one URL', 'error');
    urls = urlsText.split('\n').map(u => u.trim()).filter(u => u.length > 0);
  } else {
    urls = bulkSelectedFeeds.map(f => f.feedUrl);
  }

  if (urls.length === 0) return showAlert('No feeds selected', 'error');
  const categoryId = document.getElementById('bulkCategory').value || null;

  try {
    showAlert(`Importing ${urls.length} feeds... This may take a moment.`, 'info');
    const result = await api('/api/admin/feeds/bulk-import', { method: 'POST', body: JSON.stringify({ feeds: urls, categoryId }) });
    closeModal(new Event('click'));
    const successes = result.results.filter(r => r.success).length;
    const failures = result.results.filter(r => !r.success).length;
    showAlert(`Imported ${successes} feeds!${failures > 0 ? ` ${failures} failed.` : ''}`, 'success');
    await Promise.all([loadFeeds(), loadAnalytics()]);
  } catch (e) {
    showAlert('Bulk import failed: ' + e.message, 'error');
  }
}

async function toggleFeedActive(id, isActive) {
  try {
    await api(`/api/admin/feeds/${id}`, { method: 'PUT', body: JSON.stringify({ isActive }) });
    showAlert(`Feed ${isActive ? 'activated' : 'deactivated'}.`);
    await Promise.all([loadFeeds(), loadAnalytics()]);
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function toggleFeedFeatured(id, featured) {
  try {
    await api(`/api/admin/feeds/${id}/featured`, { method: 'PUT', body: JSON.stringify({ featured }) });
    showAlert(`Feed ${featured ? 'marked as featured' : 'removed from featured'}.`);
    await loadFeeds();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function editFeed(id) {
  try {
    const feeds = await api('/api/admin/feeds');
    const feed = feeds.find(f => f.id === id);
    if (!feed) return;

    const catOptions = categories.map(c => `<option value="${c.id}" ${c.id === feed.categoryId ? 'selected' : ''}>${esc(c.name)}</option>`).join('');

    document.getElementById('modalContent').innerHTML = `
      <h2>Edit Feed</h2>
      <div class="form-group"><label>Title</label><input type="text" id="editTitle" value="${esc(feed.title)}"></div>
      <div class="form-group"><label>Author</label><input type="text" id="editAuthor" value="${esc(feed.author || '')}"></div>
      <div class="form-group"><label>Image URL</label><input type="url" id="editImage" value="${esc(feed.imageUrl || '')}"></div>
      <div class="form-group"><label>Category</label><select id="editCategory"><option value="">Uncategorized</option>${catOptions}</select></div>
      <div class="form-group"><label>Description</label><textarea id="editDesc">${esc(feed.description || '')}</textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveFeedEdit('${id}')">Save Changes</button>
      </div>
    `;
    document.getElementById('modalOverlay').classList.remove('hidden');
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function saveFeedEdit(id) {
  try {
    const data = {
      title: document.getElementById('editTitle').value.trim(),
      author: document.getElementById('editAuthor').value.trim() || null,
      imageUrl: document.getElementById('editImage').value.trim() || null,
      categoryId: document.getElementById('editCategory').value || null,
      description: document.getElementById('editDesc').value.trim() || null,
    };
    await api(`/api/admin/feeds/${id}`, { method: 'PUT', body: JSON.stringify(data) });
    closeModal();
    showAlert('Feed updated!');
    await loadFeeds();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  ['analytics','feeds','categories','errors','feedback','messages','apk','settings'].forEach(t => {
    document.getElementById(t + 'Tab').classList.toggle('hidden', tab !== t);
  });
  if (tab === 'errors') loadErrorReports();
  if (tab === 'feedback') loadFeedback();
  if (tab === 'messages') loadMessages();
  if (tab === 'apk') loadApks();
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return `${d.getMonth()+1}/${d.getDate()}`;
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

let errorReportsPage = 1;

async function loadErrorReports(page) {
  if (page) errorReportsPage = page;
  const level = document.getElementById('errorLevelFilter').value;
  const resolved = document.getElementById('errorResolvedFilter').value;
  let url = `/api/admin/error-reports?page=${errorReportsPage}&limit=30`;
  if (level) url += `&level=${level}`;
  if (resolved !== '') url += `&resolved=${resolved}`;
  try {
    const data = await api(url);
    const list = document.getElementById('errorReportsList');
    const summary = document.getElementById('errorReportsSummary');
    summary.textContent = `${data.total} total report${data.total !== 1 ? 's' : ''} — Page ${data.page} of ${data.totalPages || 1}`;
    if (data.reports.length === 0) {
      list.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;">No error reports found</div>';
    } else {
      list.innerHTML = data.reports.map(r => {
        const levelColor = r.level === 'error' ? '#ef4444' : r.level === 'warn' ? '#f59e0b' : '#3b82f6';
        const levelBg = r.level === 'error' ? 'rgba(239,68,68,0.1)' : r.level === 'warn' ? 'rgba(245,158,11,0.1)' : 'rgba(59,130,246,0.1)';
        const time = new Date(r.createdAt).toLocaleString();
        return `<div style="padding:14px;background:#0f172a;border-radius:10px;margin-bottom:8px;border-left:3px solid ${levelColor};${r.resolved ? 'opacity:0.5;' : ''}">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:${levelBg};color:${levelColor};text-transform:uppercase;">${esc(r.level)}</span>
              <span style="font-size:11px;color:#64748b;">${esc(r.source || '')}</span>
              <span style="font-size:11px;color:#64748b;">${esc(r.platform || '')}</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:11px;color:#64748b;">${time}</span>
              ${!r.resolved ? `<button class="btn btn-success btn-sm" onclick="resolveError('${r.id}')" style="padding:3px 8px;font-size:11px;">Resolve</button>` : '<span style="font-size:11px;color:#059669;">Resolved</span>'}
            </div>
          </div>
          <div style="font-size:13px;color:#e2e8f0;word-break:break-word;margin-bottom:4px;">${esc(r.message)}</div>
          ${r.stack ? `<details style="margin-top:6px;"><summary style="font-size:11px;color:#64748b;cursor:pointer;">Stack trace</summary><pre style="font-size:11px;color:#94a3b8;margin-top:6px;white-space:pre-wrap;word-break:break-all;max-height:200px;overflow:auto;background:#0a0f1a;padding:8px;border-radius:6px;">${esc(r.stack)}</pre></details>` : ''}
          ${r.deviceId ? `<div style="font-size:11px;color:#475569;margin-top:4px;">Device: ${esc(r.deviceId.substring(0,12))}...</div>` : ''}
        </div>`;
      }).join('');
    }
    const pag = document.getElementById('errorReportsPagination');
    if (data.totalPages > 1) {
      let btns = '';
      if (data.page > 1) btns += `<button class="btn btn-secondary btn-sm" onclick="loadErrorReports(${data.page - 1})">Prev</button>`;
      btns += `<span style="font-size:13px;color:#94a3b8;padding:6px;">Page ${data.page}/${data.totalPages}</span>`;
      if (data.page < data.totalPages) btns += `<button class="btn btn-secondary btn-sm" onclick="loadErrorReports(${data.page + 1})">Next</button>`;
      pag.innerHTML = btns;
    } else {
      pag.innerHTML = '';
    }
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function resolveError(id) {
  try {
    await api(`/api/admin/error-reports/${id}/resolve`, { method: 'PUT' });
    loadErrorReports();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function deleteResolvedErrors() {
  if (!confirm('Delete all resolved error reports?')) return;
  try {
    const data = await api('/api/admin/error-reports/resolved', { method: 'DELETE' });
    showAlert(`Deleted ${data.deleted} resolved reports`, 'success');
    loadErrorReports();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

function toggleDeviceLogs(id) {
  const el = document.getElementById('logs-' + id);
  if (el) el.classList.toggle('hidden');
}

function formatDeviceLogs(logsStr) {
  try {
    const logs = JSON.parse(logsStr);
    if (!Array.isArray(logs)) return esc(logsStr);
    return logs.map(log => {
      const levelColor = log.level === 'error' ? '#ef4444' : log.level === 'warn' ? '#f59e0b' : '#94a3b8';
      const ts = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '';
      return `<div style="margin-bottom:3px;border-bottom:1px solid #1e293b;padding-bottom:3px;">
        <span style="color:${levelColor};font-weight:600;">[${esc(log.level || 'info')}]</span>
        <span style="color:#64748b;">${ts}</span>
        ${log.source ? `<span style="color:#6366f1;">[${esc(log.source)}]</span>` : ''}
        <span style="color:#e2e8f0;">${esc(log.message || '')}</span>
        ${log.stack ? `<div style="color:#64748b;margin-left:12px;font-size:10px;white-space:pre-wrap;">${esc(log.stack.substring(0, 500))}</div>` : ''}
      </div>`;
    }).join('');
  } catch {
    return esc(logsStr);
  }
}

let feedbackPage = 1;

async function loadFeedback(page) {
  if (page) feedbackPage = page;
  const type = document.getElementById('feedbackTypeFilter').value;
  const status = document.getElementById('feedbackStatusFilter').value;
  let url = `/api/admin/feedback?page=${feedbackPage}&limit=30`;
  if (type) url += `&type=${type}`;
  if (status) url += `&status=${status}`;
  try {
    const data = await api(url);
    const list = document.getElementById('feedbackList');
    if (!data.items || data.items.length === 0) {
      list.innerHTML = '<p style="color:#64748b;text-align:center;padding:40px;">No feedback found</p>';
      document.getElementById('feedbackPagination').innerHTML = '';
      return;
    }
    list.innerHTML = data.items.map(fb => {
      const typeLabel = fb.type === 'shiur_request' ? '🎵 Shiur Request' : '🔧 Technical Issue';
      const statusColor = fb.status === 'new' ? '#f59e0b' : fb.status === 'reviewed' ? '#3b82f6' : '#059669';
      const d = new Date(fb.createdAt);
      const dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      return `<div style="background:#0f172a;border-radius:10px;padding:14px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:13px;">${typeLabel}</span>
            <span style="background:${statusColor};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">${esc(fb.status)}</span>
          </div>
          <span style="font-size:11px;color:#64748b;">${dateStr}</span>
        </div>
        <div style="font-weight:600;font-size:14px;color:#f8fafc;margin-bottom:4px;">${esc(fb.subject)}</div>
        <div style="font-size:13px;color:#94a3b8;margin-bottom:8px;white-space:pre-wrap;max-height:100px;overflow-y:auto;">${esc(fb.message)}</div>
        ${fb.contactInfo ? `<div style="font-size:12px;color:#3b82f6;margin-bottom:8px;">Contact: ${esc(fb.contactInfo)}</div>` : ''}
        ${fb.adminNotes ? `<div style="font-size:12px;color:#a78bfa;margin-bottom:8px;padding:6px 8px;background:#1e1b4b;border-radius:6px;">Admin: ${esc(fb.adminNotes)}</div>` : ''}
        <div style="font-size:11px;color:#475569;margin-bottom:8px;">Device: ${esc(fb.deviceId || 'Unknown')}</div>
        ${fb.deviceLogs ? `<div style="margin-bottom:8px;">
          <button class="btn btn-secondary btn-sm" onclick="toggleDeviceLogs('${fb.id}')" style="font-size:11px;">View Device Logs</button>
          <div id="logs-${fb.id}" class="hidden" style="margin-top:6px;background:#020617;border:1px solid #1e293b;border-radius:6px;padding:8px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:11px;color:#94a3b8;">
            ${formatDeviceLogs(fb.deviceLogs)}
          </div>
        </div>` : ''}
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="updateFeedbackStatus('${fb.id}','reviewed')">Mark Reviewed</button>
          <button class="btn btn-success btn-sm" onclick="updateFeedbackStatus('${fb.id}','resolved')">Resolve</button>
          <button class="btn btn-primary btn-sm" onclick="addFeedbackNote('${fb.id}')">Add Note</button>
          <button class="btn btn-danger btn-sm" onclick="deleteFeedback('${fb.id}')">Delete</button>
        </div>
      </div>`;
    }).join('');

    const totalPages = Math.ceil((data.total || 0) / 30);
    const pag = document.getElementById('feedbackPagination');
    if (totalPages > 1) {
      let html = '';
      if (feedbackPage > 1) html += `<button class="btn btn-secondary btn-sm" onclick="loadFeedback(${feedbackPage-1})">Prev</button>`;
      html += `<span style="font-size:13px;color:#94a3b8;padding:6px;">Page ${feedbackPage} of ${totalPages}</span>`;
      if (feedbackPage < totalPages) html += `<button class="btn btn-secondary btn-sm" onclick="loadFeedback(${feedbackPage+1})">Next</button>`;
      pag.innerHTML = html;
    } else {
      pag.innerHTML = '';
    }
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function updateFeedbackStatus(id, status) {
  try {
    await api(`/api/admin/feedback/${id}`, { method: 'PUT', body: JSON.stringify({ status }) });
    showAlert('Feedback updated', 'success');
    loadFeedback();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function addFeedbackNote(id) {
  const note = prompt('Enter admin note:');
  if (note === null) return;
  try {
    await api(`/api/admin/feedback/${id}`, { method: 'PUT', body: JSON.stringify({ adminNotes: note }) });
    showAlert('Note added', 'success');
    loadFeedback();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function deleteFeedback(id) {
  if (!confirm('Delete this feedback?')) return;
  try {
    await api(`/api/admin/feedback/${id}`, { method: 'DELETE' });
    showAlert('Feedback deleted', 'success');
    loadFeedback();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

let messagesPage = 1;

async function loadMessages(page) {
  if (page) messagesPage = page;
  const status = document.getElementById('messageStatusFilter').value;
  let url = `/api/admin/contact-messages?page=${messagesPage}&limit=30`;
  if (status) url += `&status=${status}`;
  try {
    const data = await api(url);
    const list = document.getElementById('messagesList');
    if (!data.messages || data.messages.length === 0) {
      list.innerHTML = '<p style="color:#64748b;text-align:center;padding:40px;">No messages found</p>';
      document.getElementById('messagesPagination').innerHTML = '';
      return;
    }
    list.innerHTML = data.messages.map(m => {
      const statusColor = m.status === 'new' ? '#f59e0b' : m.status === 'read' ? '#3b82f6' : '#059669';
      const d = new Date(m.createdAt);
      const dateStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      return `<div style="background:#0f172a;border-radius:10px;padding:14px;margin-bottom:8px;${m.status === 'new' ? 'border-left:3px solid #f59e0b;' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-weight:600;font-size:14px;color:#f8fafc;">${esc(m.name)}</span>
            <span style="background:${statusColor};color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">${esc(m.status)}</span>
          </div>
          <span style="font-size:11px;color:#64748b;">${dateStr}</span>
        </div>
        ${m.email ? `<div style="font-size:12px;color:#3b82f6;margin-bottom:6px;">${esc(m.email)}</div>` : ''}
        <div style="font-size:13px;color:#94a3b8;white-space:pre-wrap;max-height:150px;overflow-y:auto;margin-bottom:10px;">${esc(m.message)}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${m.status === 'new' ? `<button class="btn btn-secondary btn-sm" onclick="updateMessageStatus('${m.id}','read')">Mark Read</button>` : ''}
          <button class="btn btn-success btn-sm" onclick="updateMessageStatus('${m.id}','replied')">Mark Replied</button>
          <button class="btn btn-danger btn-sm" onclick="deleteMessage('${m.id}')">Delete</button>
        </div>
      </div>`;
    }).join('');

    const totalPages = Math.ceil((data.total || 0) / 30);
    const pag = document.getElementById('messagesPagination');
    if (totalPages > 1) {
      let html = '';
      if (messagesPage > 1) html += `<button class="btn btn-secondary btn-sm" onclick="loadMessages(${messagesPage-1})">Prev</button>`;
      html += `<span style="font-size:13px;color:#94a3b8;padding:6px;">Page ${messagesPage} of ${totalPages}</span>`;
      if (messagesPage < totalPages) html += `<button class="btn btn-secondary btn-sm" onclick="loadMessages(${messagesPage+1})">Next</button>`;
      pag.innerHTML = html;
    } else {
      pag.innerHTML = '';
    }
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function updateMessageStatus(id, status) {
  try {
    await api(`/api/admin/contact-messages/${id}`, { method: 'PUT', body: JSON.stringify({ status }) });
    showAlert('Message updated', 'success');
    loadMessages();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function deleteMessage(id) {
  if (!confirm('Delete this message?')) return;
  try {
    await api(`/api/admin/contact-messages/${id}`, { method: 'DELETE' });
    showAlert('Message deleted', 'success');
    loadMessages();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function uploadApk() {
  const fileInput = document.getElementById('apkFile');
  const version = document.getElementById('apkVersion').value.trim();
  const btn = document.getElementById('uploadApkBtn');
  const file = fileInput.files[0];
  if (!file) return showAlert('Please select an APK file', 'error');
  if (!file.name.toLowerCase().endsWith('.apk')) return showAlert('Only .apk files are allowed', 'error');

  btn.disabled = true;
  btn.textContent = 'Uploading...';
  document.getElementById('apkUploadProgress').style.display = 'block';

  const formData = new FormData();
  formData.append('apk', file);
  if (version) formData.append('version', version);

  try {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/admin/apk/upload');
    xhr.setRequestHeader('Authorization', 'Basic ' + token);
    xhr.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        document.getElementById('apkProgressBar').style.width = pct + '%';
        document.getElementById('apkProgressText').textContent = pct + '% uploaded (' + (e.loaded / 1024 / 1024).toFixed(1) + ' MB / ' + (e.total / 1024 / 1024).toFixed(1) + ' MB)';
      }
    };
    xhr.onload = function() {
      btn.disabled = false;
      btn.textContent = 'Upload';
      document.getElementById('apkUploadProgress').style.display = 'none';
      if (xhr.status === 200) {
        showAlert('APK uploaded successfully!');
        fileInput.value = '';
        document.getElementById('apkVersion').value = '';
        loadApks();
      } else {
        const err = JSON.parse(xhr.responseText);
        showAlert(err.error || 'Upload failed', 'error');
      }
    };
    xhr.onerror = function() {
      btn.disabled = false;
      btn.textContent = 'Upload';
      document.getElementById('apkUploadProgress').style.display = 'none';
      showAlert('Upload failed', 'error');
    };
    xhr.send(formData);
  } catch(e) {
    btn.disabled = false;
    btn.textContent = 'Upload';
    document.getElementById('apkUploadProgress').style.display = 'none';
    showAlert(e.message, 'error');
  }
}

async function loadApks() {
  try {
    const apks = await api('/api/admin/apk');
    const list = document.getElementById('apkList');
    if (!apks || apks.length === 0) {
      list.innerHTML = '<p style="color:#64748b;text-align:center;padding:40px;">No APKs uploaded yet. Upload your first APK above.</p>';
      return;
    }
    list.innerHTML = apks.map(a => {
      const d = new Date(a.createdAt);
      const dateStr = `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      const sizeMB = (a.fileSize / 1024 / 1024).toFixed(1);
      return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:#0f172a;border-radius:10px;margin-bottom:8px;${a.isActive ? 'border:1px solid #059669;' : ''}">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <span style="font-weight:600;font-size:14px;color:#f8fafc;">${esc(a.originalName)}</span>
            ${a.isActive ? '<span style="background:#065f46;color:#6ee7b7;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ACTIVE</span>' : ''}
          </div>
          <div style="font-size:12px;color:#94a3b8;">
            ${a.version ? 'v' + esc(a.version) + ' &bull; ' : ''}${sizeMB} MB &bull; ${dateStr}
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0;">
          ${!a.isActive ? `<button class="btn btn-success btn-sm" onclick="activateApk('${a.id}')">Set Active</button>` : ''}
          <button class="btn btn-danger btn-sm" onclick="deleteApk('${a.id}')">Delete</button>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function activateApk(id) {
  try {
    await api('/api/admin/apk/' + id + '/activate', { method: 'PUT' });
    showAlert('APK set as active download');
    loadApks();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function deleteApk(id) {
  if (!confirm('Delete this APK?')) return;
  try {
    await api('/api/admin/apk/' + id, { method: 'DELETE' });
    showAlert('APK deleted');
    loadApks();
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

async function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const alertArea = document.getElementById('settingsAlert');

  if (!currentPassword || !newPassword) {
    alertArea.innerHTML = '<div class="alert alert-error">Please fill in all fields</div>';
    return;
  }
  if (newPassword.length < 6) {
    alertArea.innerHTML = '<div class="alert alert-error">New password must be at least 6 characters</div>';
    return;
  }
  if (newPassword !== confirmPassword) {
    alertArea.innerHTML = '<div class="alert alert-error">New passwords do not match</div>';
    return;
  }

  try {
    await api('/api/admin/change-password', { method: 'POST', body: JSON.stringify({ currentPassword, newPassword }) });
    alertArea.innerHTML = '<div class="alert alert-success">Password changed successfully!</div>';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    setTimeout(() => alertArea.innerHTML = '', 4000);
  } catch(e) {
    alertArea.innerHTML = `<div class="alert alert-error">${esc(e.message)}</div>`;
  }
}

if (token) { showAdmin(); }
</script>
</body>
</html>
